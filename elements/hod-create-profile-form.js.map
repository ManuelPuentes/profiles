{"version":3,"file":"hod-create-profile-form.js","sourceRoot":"","sources":["../../src/elements/hod-create-profile-form.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, css, html, query, property } from 'lit-element';\nimport { classMap } from 'lit-html/directives/class-map';\nimport { ApolloClient } from '@apollo/client/core';\n\nimport type { TextField } from '@material/mwc-textfield';\nimport '@material/mwc-textfield';\nimport '@material/mwc-button';\nimport '@material/mwc-icon-button';\nimport '@spectrum-web-components/avatar/sp-avatar.js';\n\nimport { CREATE_PROFILE } from '../graphql/queries';\nimport { sharedStyles } from '../sharedStyles';\n\n/**\n * @element hod-create-profile-form\n * @fires profile-created - after the profile has been created\n */\nexport abstract class HodCreateProfileForm extends LitElement {\n  /** Public attributes */\n\n  /**\n   * Minimum length that the username needs to have\n   * @attr min-length\n   */\n  @property({ type: Number, attribute: 'min-length' })\n  minLength = 3;\n\n  /** Dependencies */\n  abstract get _apolloClient(): ApolloClient<any>;\n\n  /** Private properties */\n\n  @query('#username-field')\n  _usernameField!: TextField;\n\n  @query('#avatar-file-picker')\n  _avatarFilePicker!: HTMLInputElement;\n\n  _existingUsernames: { [key: string]: boolean } = {};\n\n  @property({ type: String })\n  _avatar: string | undefined = undefined;\n\n  firstUpdated() {\n    this._usernameField.validityTransform = (newValue: string) => {\n      this.requestUpdate();\n      if (newValue.length < this.minLength) {\n        this._usernameField.setCustomValidity(\n          `Username is too shot, min. ${this.minLength} characters`\n        );\n        return {\n          valid: false,\n        };\n      } else if (this._existingUsernames[newValue]) {\n        this._usernameField.setCustomValidity('This username already exists');\n        return { valid: false };\n      }\n\n      return {\n        valid: true,\n      };\n    };\n  }\n\n  static get styles() {\n    return sharedStyles;\n  }\n\n  async createProfile() {\n    const username = this._usernameField.value;\n    try {\n      await this._apolloClient.mutate({\n        mutation: CREATE_PROFILE,\n        variables: {\n          profile: {\n            username,\n            avatar: this._avatar,\n          },\n        },\n      });\n\n      this.dispatchEvent(\n        new CustomEvent('profile-created', {\n          detail: {\n            profile: {\n              username,\n              avatar: this._avatar,\n            },\n          },\n          bubbles: true,\n          composed: true,\n        })\n      );\n    } catch (e) {\n      console.log(e)\n      this._existingUsernames[username] = true;\n      this._usernameField.reportValidity();\n    }\n  }\n\n  // Crop the image and return a base64 bytes string of its content\n  cropPlusExport(\n    img: HTMLImageElement,\n    cropX: number,\n    cropY: number,\n    cropWidth: number,\n    cropHeight: number\n  ) {\n    // create a temporary canvas sized to the cropped size\n    const canvas1 = document.createElement('canvas');\n    const ctx1 = canvas1.getContext('2d');\n    canvas1.width = cropWidth;\n    canvas1.height = cropHeight;\n    // use the extended from of drawImage to draw the\n    // cropped area to the temp canvas\n    ctx1?.drawImage(\n      img,\n      cropX,\n      cropY,\n      cropWidth,\n      cropHeight,\n      0,\n      0,\n      cropWidth,\n      cropHeight\n    );\n    // return the .toDataURL of the temp canvas\n    return canvas1.toDataURL();\n  }\n\n  onAvatarUploaded() {\n    if (this._avatarFilePicker.files && this._avatarFilePicker.files[0]) {\n      const reader = new FileReader();\n      reader.onload = e => {\n        const img = new Image();\n        img.crossOrigin = 'anonymous';\n        img.onload = () => {\n          this._avatar = this.cropPlusExport(img, 0, 0, 100, 100);\n        };\n        img.src = e.target?.result as string;\n      };\n      reader.readAsDataURL(this._avatarFilePicker.files[0]);\n    }\n  }\n\n  render() {\n    return html`\n      <input\n        type=\"file\"\n        id=\"avatar-file-picker\"\n        style=\"display: none;\"\n        @change=${this.onAvatarUploaded}\n      />\n\n      <div class=\"column\">\n        <div class=\"row center-content\">\n          ${this._avatar\n            ? html`\n                <sp-avatar\n                  label=\"Avatar\"\n                  src=\"${this._avatar}\"\n                  style=\"margin-bottom: 19px;\"\n                ></sp-avatar>\n              `\n            : html`\n                <mwc-icon-button\n                  label=\"Add avatar\"\n                  icon=\"add\"\n                  @click=${() => this._avatarFilePicker.click()}\n                >\n                </mwc-icon-button>\n              `}\n\n          <mwc-textfield\n            id=\"username-field\"\n            outlined\n            label=\"Username\"\n            @input=${() => this._usernameField.reportValidity()}\n            style=\"margin-left: 8px;\"\n          ></mwc-textfield>\n        </div>\n        <mwc-button\n          id=\"create-profile-button\"\n          raised\n          class=${classMap({\n            'small-margin': !!this._usernameField,\n            'big-margin': !this._usernameField,\n          })}\n          .disabled=${!this._usernameField ||\n          !this._usernameField.validity.valid}\n          label=\"CREATE PROFILE\"\n          @click=${() => this.createProfile()}\n        ></mwc-button>\n      </div>\n    `;\n  }\n}\n"]}